<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>redirecting...</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; }
    .btn { display:inline-block; padding:10px 14px; border:1px solid #999; border-radius:8px; text-decoration:none; }
  </style>
</head>
<body>
  <p>フォームへ移動しています…</p>
  <p><a id="fallback" class="btn" href="#">開かない場合はこちら</a></p>

<script>
(function(){
  // ★ あなたのGAS /exec に差し替え（末尾 /exec の完全URL）
  const GAS_EXEC = "https://script.google.com/macros/s/AKfycbzK6kaL13DaDIvIZ72Gnshd0YzR2vZtTwI8AudIxjeLP7JSVUlgj9rFlq9VbeuEomGzSg/exec";

  // URLクエリ
  const qs   = new URLSearchParams(location.search);
  const snd  = qs.get("snd_id") || "";                 // ← 追加メタ（送り主IDなど）

  // ランダムID（5文字）
  function rid5(){
    const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let r=""; for(let i=0;i<5;i++) r+=s.charAt(Math.floor(Math.random()*s.length)); return r;
  }

  const rid = rid5();
  const ua  = navigator.userAgent || "";
  const ref = document.referrer || "";
  let ip = ""; // 後で埋まる（失敗なら空）

  // グローバルIP取得（非同期・失敗しても無視）
  fetch("https://api.ipify.org?format=json").then(r=>r.json()).then(j=>{ ip = j.ip || ""; }).catch(()=>{});

  // ==== GASから設定(JSONP)を取得してフォームURLを組み立て ====
  const cb = "conf_cb_" + Math.random().toString(36).slice(2);
  window[cb] = function(conf){
    try {
      const base = conf.form_base_url || "";
      const key  = conf.form_entry_key || "";
      if(!base || !key) throw new Error("設定が空です（form_base_url / form_entry_key）");

      // 事前入力（rid）を付与
      const dest = base + (base.indexOf("?")>=0 ? "&" : "?") + key + "=" + encodeURIComponent(rid);

      // 連打ガード付き遷移
      const link = document.getElementById("fallback");
      link.href = dest;

      let navigating = false;
      function go() {
        if (navigating) return;
        navigating = true;
        link.textContent = "開いています…";
        link.style.pointerEvents = "none";
        link.style.opacity = "0.6";
        try { window.location.replace(dest); } catch(e) { window.location.href = dest; }
      }
      link.addEventListener("click", function (e) { e.preventDefault(); go(); });

      // ==== ログ送信（snd_id / referrer / ip 付き）====
      // 1) fetch keepalive（POST）
      try {
        fetch(GAS_EXEC + "?log=1", {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ rid, ua, ref, ip, snd_id: snd }),
          keepalive: true
        }).catch(()=>{});
      } catch(e){}

      // 2) sendBeacon（POST）
      try {
        navigator.sendBeacon(
          GAS_EXEC + "?log=1",
          new Blob([JSON.stringify({ rid, ua, ref, ip, snd_id: snd })], { type: "text/plain" })
        );
      } catch(e){}

      // 3) 画像GET（キャッシュバスター付）
      try {
        const img = new Image();
        img.src = GAS_EXEC + "?log=1"
          + "&rid=" + encodeURIComponent(rid)
          + "&ua="  + encodeURIComponent(ua)
          + "&ref=" + encodeURIComponent(ref)
          + "&ip="  + encodeURIComponent(ip)
          + "&snd_id=" + encodeURIComponent(snd)
          + "&t=" + Date.now();
      } catch(e){}

      // 0.4秒後に自動遷移（iOS対策＆体感改善）
      setTimeout(go, 400);

    } catch(err) {
      // 失敗時もリンクからは開けるようにしておく
      const link = document.getElementById("fallback");
      link.textContent = "フォームを開く（エラー: " + err.message + "）";
    }
  };

  // JSONPロード
  const s = document.createElement("script");
  s.src = GAS_EXEC + "?cfg=1&callback=" + cb;
  s.async = true;
  document.head.appendChild(s);
})();
</script>
</body>
</html>
